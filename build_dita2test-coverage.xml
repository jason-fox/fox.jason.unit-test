<?xml version="1.0" encoding="UTF-8"?><!--
	This file is part of the DITA-OT Unit Test Plug-in project.
	See the accompanying LICENSE file for applicable licenses.
--><project xmlns:if="ant:if" xmlns:unless="ant:unless" name="fox.jason.unit-test.coverage">
	<!--
		Generate a coverage report.
	-->
	<target depends="unit-test.log.init" name="template-coverage">
		<unit-test-log id="UNIT002I" level="info" message="Running a template-coverage report"/>
		<property name="test.coverage.report" value="true"/>
	</target>

	<!--
		Generate a coverage report.
	-->
	<target depends="unit-test.log.init" name="test-coverage">
		<unit-test-log id="UNIT002I" level="info" message="Running a test-coverage report"/>
		<property name="coverage.includes" value="**/expected.*"/>
		<property name="coverage.file" value="coverage.xml"/>
		<property name="test.coverage.report" value="true"/>
	</target>

	<!--
		Generate a coverage report.
	-->
	<target if="test.coverage.report" name="coverage.report">
		<!-- The default report is an instrumented report -->
		<property name="coverage.includes" value="**/out/templates-covered.txt"/>
		<property name="coverage.file" value="template-coverage.xml"/>

		<tempfile deleteonexit="true" destdir="${dita.temp.dir}" property="coverage.report.xml"/>
		<xmltask dest="${coverage.report.xml}" source="${dita.plugin.fox.jason.unit-test.dir}/resource/coverage.xml"/>
		<for param="test-suite.dir">
			<path>
				<dirset dir="${test.root.dir}" includes="*">
					<depth max="1"/>
				</dirset>
			</path>
			<sequential>
				<propertyregex casesensitive="false" input="@{test-suite.dir}" override="true" property="test-suite" regexp="([^/]*)$" select="\1"/>
				<local name="test-suite.coverage"/>
				<available file="@{test-suite.dir}/test/${coverage.file}" property="test-suite.coverage"/>
				<xmltask dest="${coverage.report.xml}" if:set="test-suite.coverage" source="${coverage.report.xml}">
					<insert file="@{test-suite.dir}/test/${coverage.file}" path="testsuites"/>
				</xmltask>
				<coverage-runner dir="@{test-suite.dir}" if:set="test-suite.coverage" resultfile="${coverage.report.xml}" includes="${coverage.includes}" file="${coverage.file}"/>
			</sequential>
		</for>
		<xslt classpathref="dost.class.path" in="${coverage.report.xml}" out="${output.dir}/coverage.html" style="${dita.plugin.fox.jason.unit-test.dir}/xsl/coverage-report.xsl"/>
	</target>
	<!--
		Setting up pre-processing for Antro. Checks that mandatory parameters are present
		and loads dependent libaries
	-->
	<target name="antro.init">
		<dita-ot-fail id="DOTA069F">
			<condition>
				<not>
					<available file="${args.input}" type="file"/>
				</not>
			</condition>
			<param name="1" value="${args.input}"/>
		</dita-ot-fail>
		<dita-ot-fail id="UNIT003F">
			<condition>
				<not>
					<isset property="test.transtype"/>
				</not>
			</condition>
		</dita-ot-fail>
		<taskdef resource="net/sf/antcontrib/antlib.xml">
			<classpath>
				<pathelement location="${dita.plugin.fox.jason.unit-test.dir}/lib/ant-contrib-1.0b3.jar"/>
			</classpath>
		</taskdef>
	</target>
	<!--
		Generate a profiler report. Run DITA-OT using the test.transtype
	-->
	<target depends="unit-test.log.init" name="antro">
		<unit-test-log id="UNIT002I" level="info" message="Generating an Antro profiling report"/>
		<var name="transtype" unset="true"/>
		<property name="transtype" value="${test.transtype}"/>
		<tempfile createfile="true" deleteonexit="true" destdir="${dita.temp.dir}" property="test.propertyfile"/>
		<java classname="org.apache.tools.ant.launch.Launcher" fork="true">
			<arg value="-buildfile"/>
			<arg value="${dita.dir}/build.xml"/>
			<arg value="-Dtranstype=${transtype}"/>
			<arg value="-Dargs.input=${args.input}"/>
			<arg value="-Dantro.dir=${output.dir}"/>
			<arg value="-listener"/>
			<arg value="ru.jkff.antro.ProfileListener"/>
			<arg value="-propertyfile"/>
			<arg value="${test.propertyfile}"/>
			<classpath>
				<pathelement location="${dita.plugin.fox.jason.unit-test.dir}/lib/antro.jar"/>
				<pathelement location="${dita.plugin.fox.jason.unit-test.dir}/lib/json.jar"/>
				<fileset dir="${dita.dir}/lib">
					<include name="*.jar"/>
				</fileset>
			</classpath>
		</java>
	</target>
	<!--
		Invoke the Antro UI from the command line
	-->
	<target depends="unit-test.log.init" name="antro.ui">
		<unit-test-log id="UNIT002I" level="info" message="Invoking Antro UI"/>
		<java classname="ru.jkff.antro.ui.Main" fork="true" spawn="true" unless:set="test.no-spawn">
			<classpath>
				<pathelement location="${dita.plugin.fox.jason.unit-test.dir}/lib/antro.jar"/>
				<pathelement location="${dita.plugin.fox.jason.unit-test.dir}/lib/json.jar"/>
				<pathelement location="${dita.plugin.fox.jason.unit-test.dir}/lib/swingx-2008_03_09.jar"/>
			</classpath>
		</java>
	</target>

	<target name="instrument.init" depends="unit-test.log.init">
		<dita-ot-fail id="DOTA069F">
			<condition>
				<not>
					<available file="${args.input}" type="dir"/>
				</not>
			</condition>
			<param name="1" value="${args.input}"/>
		</dita-ot-fail>
		<taskdef resource="net/sf/antcontrib/antlib.xml">
			<classpath>
				<pathelement location="${dita.plugin.fox.jason.unit-test.dir}/lib/ant-contrib-1.0b3.jar"/>
			</classpath>
		</taskdef>
	</target>
	<!--
		Instrumentation of a DITA-OT plugin
	-->
	<target name="instrument">
		<unit-test-log id="UNIT002I" level="info" message="Instrumenting XSL Templates"/>

		<property name="test.instrument.xsl.dir" value="${dita.plugin.fox.jason.unit-test.dir}/xsl"/>
		<property name="test.instrument.report.file" value="${args.input}/test/template-coverage.xml"/>

		<pathconvert property="test.coverage.source" dirsep="/">
		  <map from="${dita.dir}/plugins/" to=""/>
		  <path location="${args.input}"/>
		</pathconvert>


		<xslt classpathref="dost.class.path" destdir="${dita.temp.dir}/coverage" extension=".xml" style="${test.instrument.xsl.dir}/instrument-listing.xsl" basedir="${args.input}" includes="**/*.xsl">
			<param expression="${dita.dir}/plugins/${test.coverage.source}" name="SOURCE"/>
		</xslt>


		<xslt classpathref="dost.class.path" force="true" in="${test.instrument.xsl.dir}/listing-merge.xsl" out="${test.instrument.report.file}" style="${test.instrument.xsl.dir}/listing-merge.xsl">
			<param expression="${dita.temp.dir}/coverage" name="in"/>
			<param expression="${test.coverage.source}" name="SOURCE"/>
		</xslt>



		<copy todir="${args.input}">
		  <fileset dir="${args.input}">
			<include name="**/*.xsl"/>
		  </fileset>
		  <globmapper from="*" to="*.orig"/>
		</copy>


		<xslt classpathref="dost.class.path" style="${test.instrument.xsl.dir}/instrument-file.xsl" destdir="${dita.temp.dir}/plugins" basedir="${args.input}" includes="**/*.xsl" extension=".xsl">
			<param expression="${dita.dir}/plugins/${test.coverage.source}" name="SOURCE"/>
		</xslt>

		<move todir="${args.input}">
		  <fileset dir="${dita.temp.dir}/plugins">
			<include name="**/*.xsl"/>
		  </fileset>
		</move>
	</target>
	<!--
		Deinstrumentation of a DITA-OT plugin
	-->
	<target name="deinstrument">
		<unit-test-log id="UNIT002I" level="info" message="Reverting instrumentation of XSL Templates"/>
		<move todir="${args.input}">
		  <fileset dir="${args.input}">
			<include name="**/*.xsl.orig"/>
		  </fileset>
		  <globmapper from="*.xsl.orig" to="*.xsl"/>
		</move>
	</target>


	<!--
		Ant target executed to run a unit test coverage report.
	-->
	<target depends="build-init,unit-test.init,test-coverage,coverage.report" name="dita2test-coverage"/>
	<target depends="build-init,unit-test.init,template-coverage,coverage.report" name="dita2template-coverage"/>
	<!--
		Ant target executed to instrument a plug-in
	-->
	<target depends="build-init,instrument.init,instrument" name="dita2instrument-templates"/>
		<!--
		Ant target executed to deinstrument a plugin
	-->
	<target depends="build-init,instrument.init,deinstrument" name="dita2deinstrument-templates"/>
	<!--
		Ant target executed when the running the Antro profiler
	-->
	<target depends="build-init,antro.init,antro" name="dita2antro"/>
	<!--
		Ant target executed to invoke the Antro UI
	-->
	<target depends="antro.ui" name="dita2antro-ui"/>
</project>